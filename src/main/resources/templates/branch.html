<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{documentTitle}}</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="256x256" href="/favicon-256x256.png">
    <link rel="icon" type="image/png" sizes="128x128" href="/favicon-128x128.png">
    <link rel="icon" type="image/png" sizes="64x64" href="/favicon-64x64.png">
    <link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <!-- Element UI CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow-x: hidden;
        }

        #app {
            margin: 0;
            padding: 0;
            width: 100%;
            min-height: 100vh;
        }

        [v-cloak] {
            display: none !important;
        }

        .page-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-content {
            text-align: center;
            color: #409eff;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #409eff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .commit-message-container {
            position: relative;
            display: flex;
            align-items: center;
            max-width: 100%;
        }

        .commit-message-text {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            line-height: 1.4;
            max-height: 4.2em;
        }

        .commit-message-icon {
            margin-left: 8px;
            cursor: pointer;
            color: #409eff;
            font-size: 14px;
            flex-shrink: 0;
        }

        .commit-message-icon:hover {
            color: #66b1ff;
        }

        .commit-message-container span {
            flex-shrink: 0;
            margin-right: 4px;
        }

        .header {
            background-color: #545c64;
            color: #fff;
            line-height: 60px;
            padding: 0 20px;
            font-size: 20px;
            font-weight: bold;
        }

        .container {
            display: flex;
            height: calc(100vh - 60px);
        }

        .sidebar {
            width: 200px;
            background-color: #324157;
        }

        .main-content {
            flex: 1;
            padding: 10px;
            background-color: #f5f5f5;
        }

        .content-card {
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, .12), 0 0 6px rgba(0, 0, 0, .04);
        }

        .search-form {
            padding: 20px;
            border-bottom: 1px solid #e6e6e6;
        }

        .table-container {
            padding: 20px;
        }

        .page-title {
            margin-bottom: 20px;
            font-size: 24px;
            font-weight: bold;
            color: #303133;
        }
        /* 勾选行高亮底色 */
        .el-table .row-selected > td {
            background-color: rgb(255, 241, 230) !important;
        }
    </style>
</head>
<body>
<!-- 初始加载页面 -->
<div id="page-loading" class="page-loading">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <div>正在加载页面...</div>
    </div>
</div>

<div id="app" v-cloak>
    <!-- 头部 -->
    <div class="header">
        <span>Git合流管理系统</span>
        <div style="float: right;">
            <el-button type="primary" @click="handleOperatorLogin">{{operatorButtonText}}</el-button>
        </div>
    </div>

    <!-- 主容器 -->
    <div class="container">
        <!-- 侧边栏 -->
        <div class="sidebar">
            <el-menu
                    default-active="1"
                    class="el-menu-vertical"
                    background-color="#324157"
                    text-color="#bfcbd9"
                    active-text-color="#409EFF"
                    @select="handleMenuSelect">
                <el-menu-item index="1">
                    <i class="el-icon-files"></i>
                    <span slot="title">Git工程管理</span>
                </el-menu-item>
                <el-menu-item index="2">
                    <i class="el-icon-office-building"></i>
                    <span slot="title">Git组织管理</span>
                </el-menu-item>
            </el-menu>
        </div>

        <!-- 主内容区 -->
        <div class="main-content">
            <div class="page-title">{{pageTitle}}分支管理</div>

            <div class="content-card">
                <!-- 搜索表单 -->
                <div class="search-form">
                    <div class="demo-form-inline" style="display: flex; align-items: center; gap: 10px;">
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <label>分支名称</label>
                            <el-input v-model="searchForm.branchName" placeholder="请输入分支名称"
                                      clearable
                                      @keyup.enter.native="handleEnterKey"
                                      style="width: 200px;"></el-input>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <el-button type="primary" @click="handleSearch" :loading="searchLoading">搜索</el-button>
                            <el-button @click="handleReset">重置</el-button>
                            <el-button type="primary" @click="handleCreateBranch">新建分支</el-button>
                            <el-button type="danger" @click="handleBatchDelete"
                                       :disabled="selectedBranches.length === 0" :loading="batchDeleteLoading">清理分支
                            </el-button>
                            <el-button type="success" @click="handlePullRemoteBranch" :loading="pullRemoteLoading">
                                拉取远程分支
                            </el-button>
                        </div>
                    </div>
                </div>

                <!-- 表格 -->
                <div class="table-container">
                    <el-table
                            :data="tableData"
                            v-loading="loading"
                            :row-class-name="branchRowClassName"
                            @selection-change="handleSelectionChange"
                            style="width: 100%"
                            element-loading-text="正在加载中..."
                            element-loading-spinner="el-icon-loading">
                        <el-table-column type="selection" width="55"></el-table-column>
                        <el-table-column prop="branchName" label="分支名称" width="200"></el-table-column>
                        <el-table-column prop="branchDesc" label="分支描述" min-width="150"></el-table-column>
                        <el-table-column prop="createTime" label="创建时间" width="180"></el-table-column>
                        <el-table-column prop="createBy" label="创建人" width="120"></el-table-column>
                        <el-table-column prop="lastCommitTime" label="最近提交时间" width="180"></el-table-column>
                        <el-table-column label="最近提交内容" min-width="200">
                            <template slot-scope="scope">
                                <div class="commit-message-container">
                                    <div class="commit-message-text">{{scope.row.lastCommitMessage}}</div>
                                    <el-tooltip
                                            v-if="scope.row.lastCommitMessage && scope.row.lastCommitMessage.length > 120"
                                            :content="scope.row.lastCommitMessage"
                                            placement="top"
                                            effect="dark">
                                        <i class="el-icon-info commit-message-icon"></i>
                                    </el-tooltip>
                                </div>
                            </template>
                        </el-table-column>
                        <el-table-column prop="lastCommitUser" label="最近提交人" width="120"></el-table-column>
                        <el-table-column label="操作" width="180">
                            <template slot-scope="scope">
                                <el-button size="mini" type="primary" @click="handleEditBranch(scope.row)">编辑</el-button>
                                <el-button size="mini" type="danger" @click="handleDeleteBranch(scope.row)">清理分支
                                </el-button>
                            </template>
                        </el-table-column>
                    </el-table>

                    <!-- 分页 -->
                    <el-pagination
                            @size-change="handleSizeChange"
                            @current-change="handleCurrentChange"
                            :current-page="pagination.current"
                            :page-sizes="[10, 20, 50, 100]"
                            :page-size="pagination.size"
                            layout="total, sizes, prev, pager, next, jumper"
                            :total="pagination.total"
                            style="margin-top: 20px; text-align: right;">
                    </el-pagination>
                </div>
            </div>
        </div>
    </div>

    <!-- 新建分支弹窗 -->
    <el-dialog title="新建分支" :visible.sync="createBranchVisible" width="500px">
        <el-form :model="createBranchForm" :rules="createBranchRules" ref="createBranchForm" label-width="100px">
            <el-form-item label="Git工程">
                <el-input v-model="pageTitle" disabled></el-input>
            </el-form-item>
            <el-form-item label="来源分支" prop="sourceBranch">
                <el-select v-model="createBranchForm.sourceBranch" 
                           filterable
                           remote
                           clearable
                           :remote-method="filterSourceBranches"
                           @clear="handleClearSourceBranch"
                           placeholder="请输入分支名称进行搜索" 
                           style="width: 100%">
                    <el-option
                            v-for="branch in filteredSourceBranches"
                            :key="branch.branchName"
                            :label="branch.branchName"
                            :value="branch.branchName">
                    </el-option>
                </el-select>
            </el-form-item>
            <el-form-item label="分支名称" prop="branchName">
                <el-input v-model="createBranchForm.branchName" placeholder="请输入分支名称" maxlength="100"></el-input>
            </el-form-item>
            <el-form-item label="分支描述" prop="branchDesc">
                <el-input v-model="createBranchForm.branchDesc" placeholder="请输入分支描述" maxlength="200"
                          type="textarea"></el-input>
            </el-form-item>
        </el-form>
        <div slot="footer" class="dialog-footer">
            <el-button @click="createBranchVisible = false">取消</el-button>
            <el-button type="primary" @click="handleSaveBranch" :loading="saveBranchLoading">保存</el-button>
        </div>
    </el-dialog>

    <!-- 编辑分支弹窗 -->
    <el-dialog title="编辑分支" :visible.sync="editBranchVisible" width="500px">
        <el-form :model="editBranchForm" :rules="editBranchRules" ref="editBranchForm" label-width="100px">
            <el-form-item label="分支名称" prop="branchName">
                <el-input v-model="editBranchForm.branchName" disabled></el-input>
            </el-form-item>
            <el-form-item label="分支备注" prop="branchDesc">
                <el-input v-model="editBranchForm.branchDesc" placeholder="请输入分支备注" maxlength="200" type="textarea"></el-input>
            </el-form-item>
            <el-form-item label="创建人" prop="createBy">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <el-input v-model="editBranchForm.createBy" placeholder="请输入创建人" style="flex: 1;"></el-input>
                    <el-button size="mini" type="info" @click="fillOperator">填充操作人</el-button>
                </div>
            </el-form-item>
        </el-form>
        <div slot="footer" class="dialog-footer">
            <el-button @click="editBranchVisible = false">关闭</el-button>
            <el-button type="primary" @click="handleSaveEditBranch" :loading="saveEditBranchLoading">保存</el-button>
        </div>
    </el-dialog>

    <!-- 操作人登录弹窗 -->
    <el-dialog title="操作人登录" :visible.sync="operatorLoginVisible" width="400px" :close-on-click-modal="false" :close-on-press-escape="false">
        <div style="padding: 20px;">
            <div style="display: flex; align-items: center; margin-bottom: 20px;">
                <label style="width: 80px; text-align: right; margin-right: 10px;">操作人：</label>
                <el-input v-model="operatorForm.operator" placeholder="请输入操作人" 
                          @keyup.enter.native="handleEnterKeySave" style="flex: 1;"></el-input>
            </div>
        </div>
        <div slot="footer" class="dialog-footer">
            <el-button @click="handleCloseOperatorDialog">关闭</el-button>
            <el-button type="primary" @click="handleSaveOperator">保存</el-button>
        </div>
    </el-dialog>
</div>

<!-- Vue和Element UI -->
<script src="https://unpkg.com/vue@2/dist/vue.js"></script>
<script src="https://unpkg.com/element-ui/lib/index.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

<script>
    new Vue({
        el: '#app',
        data() {
            return {
                loading: false,
                searchLoading: false,
                saveBranchLoading: false,
                deleteBranchLoading: false,
                batchDeleteLoading: false,
                pullRemoteLoading: false,
                editBranchLoading: false,
                saveEditBranchLoading: false,
                editBranchVisible: false,
                editBranchForm: {
                    branchId: null,
                    branchName: '',
                    branchDesc: '',
                    createBy: ''
                },
                editBranchRules: {
                    branchDesc: [
                        {required: true, message: '请输入分支备注', trigger: 'blur'},
                        {max: 200, message: '长度不能超过200字符', trigger: 'blur'}
                    ],
                    createBy: [
                        {required: true, message: '请输入创建人', trigger: 'blur'}
                    ]
                },
                searchForm: {
                    branchName: ''
                },
                tableData: [],
                pagination: {
                    current: 1,
                    size: 10,
                    total: 0
                },
                selectedBranches: [],
                projectId: null,
                pageTitle: '',
                documentTitle: '分支管理 - Git合流管理系统',
                createBranchVisible: false,
                createBranchForm: {
                    sourceBranch: '',
                    branchName: '',
                    branchDesc: ''
                },
                createBranchRules: {
                    sourceBranch: [
                        {required: true, message: '请选择来源分支', trigger: 'change'}
                    ],
                    branchName: [
                        {required: true, message: '请输入分支名称', trigger: 'blur'},
                        {max: 100, message: '长度不能超过100字符', trigger: 'blur'}
                    ],
                    branchDesc: [
                        {max: 200, message: '长度不能超过200字符', trigger: 'blur'}
                    ]
                },
                sourceBranches: [],
                filteredSourceBranches: [],
                // 操作人相关
                operatorLoginVisible: false,
                operatorForm: {
                    operator: ''
                },
                operatorButtonText: '登录'
            }
        },
        watch: {
            // 监听文档标题变化
            documentTitle: {
                handler(newTitle) {
                    if (newTitle) {
                        document.title = newTitle;
                    }
                },
                immediate: true
            }
        },
        mounted() {
            // 隐藏初始loading页面
            const pageLoading = document.getElementById('page-loading');
            if (pageLoading) {
                pageLoading.style.display = 'none';
            }

            // 确保searchForm初始化
            this.$nextTick(() => {
                // 强制重新设置searchForm以确保响应式
                this.$set(this, 'searchForm', {
                    branchName: ''
                });
            });

            this.initOperator();
            this.initPage();
            this.loadData();
            
            // 添加全局回车键事件监听，阻止除特定输入框外的回车键事件
            this.addGlobalEnterKeyHandler();
        },
        methods: {
            // 初始化页面
            initPage() {
                const urlParams = new URLSearchParams(window.location.search);
                this.projectId = urlParams.get('projectId');
                this.pageTitle = urlParams.get('projectName') || '';

                // 更新页面标题
                if (this.pageTitle) {
                    this.documentTitle = `${this.pageTitle}-分支管理 - Git合流管理系统`;
                    // 同时更新浏览器标题
                    document.title = this.documentTitle;
                }
            },

            // 加载数据
            loadData() {
                this.loading = true;
                const params = {
                    currentPage: this.pagination.current,
                    pageSize: this.pagination.size,
                    param: {
                        gitProjectId: this.projectId,
                        branchName: this.searchForm.branchName || null
                    }
                };

                axios.post('/api/v1/git-merge-flow/pageGitBranch', params)
                    .then(response => {
                        if (response?.data?.code === 200) {
                            this.tableData = response.data.data.records;
                            this.pagination.total = response.data.data.total;
                        } else {
                            this.$message.error(response.data.message || '查询失败');
                        }
                    })
                    .catch(error => {
                        this.$message.error('网络请求失败');
                        console.error(error);
                    })
                    .finally(() => {
                        this.loading = false;
                        this.searchLoading = false;
                    });
            },

            // 分页大小改变
            handleSizeChange(val) {
                this.pagination.size = val;
                this.pagination.current = 1;
                this.loadData();
            },

            // 当前页改变
            handleCurrentChange(val) {
                this.pagination.current = val;
                this.loadData();
            },

            // 菜单选择
            handleMenuSelect(key) {
                if (key === '1') {
                    window.location.href = '/project';
                } else if (key === '2') {
                    window.location.href = '/organization';
                }
            },

            // 选择改变
            handleSelectionChange(val) {
                this.selectedBranches = val;
            },

            // 新建分支
            handleCreateBranch() {
                this.loadSourceBranches();
                this.createBranchVisible = true;
            },

            // 加载来源分支
            loadSourceBranches() {
                const params = {
                    gitProjectId: this.projectId,
                    includeDefaultBranch: true // 包含默认分支
                };

                axios.post('/api/v1/git-merge-flow/listGitBranch', params)
                    .then(response => {
                        if (response?.data?.code === 200) {
                            this.sourceBranches = response.data.data;
                            // 初始化过滤后的列表
                            this.filteredSourceBranches = [...this.sourceBranches];
                            // 默认选中默认分支
                            const defaultBranch = this.sourceBranches.find(b => b.defaultBranchFlag === 1);
                            if (defaultBranch) {
                                this.createBranchForm.sourceBranch = defaultBranch.branchName;
                            }
                        } else {
                            this.$message.error('获取来源分支失败');
                        }
                    })
                    .catch(error => {
                        this.$message.error('网络请求失败');
                        console.error(error);
                    });
            },

            // 过滤来源分支列表（支持模糊查询）
            filterSourceBranches(query) {
                if (!query || query === '') {
                    this.filteredSourceBranches = [...this.sourceBranches];
                } else {
                    this.filteredSourceBranches = this.sourceBranches.filter(branch =>
                        branch.branchName.toLowerCase().includes(query.toLowerCase())
                    );
                }
            },

            // 处理来源分支清空事件
            handleClearSourceBranch() {
                // 清空时显示所有分支选项
                this.filteredSourceBranches = [...this.sourceBranches];
            },

            // 保存分支
            handleSaveBranch() {
                this.$refs.createBranchForm.validate((valid) => {
                    if (valid) {
                        const operator = localStorage.getItem('operator');
                        if (!operator) {
                            this.$message.error('请先登录设置操作人');
                            return;
                        }

                        this.saveBranchLoading = true;

                        const params = {
                            gitProjectId: this.projectId,
                            sourceBranch: this.createBranchForm.sourceBranch,
                            gitBranchName: this.createBranchForm.branchName,
                            branchDesc: this.createBranchForm.branchDesc,
                            operator: operator
                        };

                        axios.post('/api/v1/git-merge-flow/createGitBranch', params)
                            .then(response => {
                                if (response?.data?.code === 200) {
                                    this.$message.success('创建成功');
                                    this.createBranchVisible = false;
                                    this.createBranchForm = {
                                        sourceBranch: '',
                                        branchName: '',
                                        branchDesc: ''
                                    };
                                    this.loadData();
                                } else {
                                    this.$message.error(response.data.message || '创建失败');
                                }
                            })
                            .catch(error => {
                                this.$message.error('网络请求失败');
                                console.error(error);
                            })
                            .finally(() => {
                                this.saveBranchLoading = false;
                            });
                    }
                });
            },

            // 删除单个分支
            handleDeleteBranch(row) {
                this.$confirm('确认删除该分支吗？', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    const operator = localStorage.getItem('operator');
                    if (!operator) {
                        this.$message.error('请先登录设置操作人');
                        return;
                    }

                    this.deleteBranchLoading = true;

                    const params = {
                        projectId: this.projectId,
                        gitBranchNameList: [row.branchName],
                        operator: operator
                    };

                    axios.post('/api/v1/git-merge-flow/deleteGitBranch', params)
                        .then(response => {
                            if (response?.data?.code === 200) {
                                this.$message.success('删除成功');
                                this.loadData();
                            } else {
                                this.$message.error(response.data.message || '删除失败');
                            }
                        })
                        .catch(error => {
                            this.$message.error('网络请求失败');
                            console.error(error);
                        })
                        .finally(() => {
                            this.deleteBranchLoading = false;
                        });
                });
            },

            // 批量删除分支
            handleBatchDelete() {
                if (this.selectedBranches.length === 0) {
                    this.$message.warning('请选择要删除的分支');
                    return;
                }

                this.$confirm(`确认删除选中的${this.selectedBranches.length}个分支吗？`, '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    const operator = localStorage.getItem('operator');
                    if (!operator) {
                        this.$message.error('请先登录设置操作人');
                        return;
                    }

                    this.batchDeleteLoading = true;

                    const params = {
                        projectId: this.projectId,
                        gitBranchNameList: this.selectedBranches.map(b => b.branchName),
                        operator: operator
                    };

                    axios.post('/api/v1/git-merge-flow/deleteGitBranch', params)
                        .then(response => {
                            if (response?.data?.code === 200) {
                                this.$message.success('删除成功');
                                this.loadData();
                            } else {
                                this.$message.error(response.data.message || '删除失败');
                            }
                        })
                        .catch(error => {
                            this.$message.error('网络请求失败');
                            console.error(error);
                        })
                        .finally(() => {
                            this.batchDeleteLoading = false;
                        });
                });
            },

            // 编辑分支
            handleEditBranch(row) {
                this.editBranchLoading = true;
                
                const params = {
                    branchId: row.branchId
                };

                axios.post('/api/v1/git-merge-flow/queryGitBranch', params)
                    .then(response => {
                        if (response?.data?.code === 200) {
                            const branchData = response.data.data;
                            this.editBranchForm = {
                                branchId: branchData.branchId,
                                branchName: branchData.branchName,
                                branchDesc: branchData.branchDesc || '',
                                createBy: branchData.createBy || ''
                            };
                            this.editBranchVisible = true;
                        } else {
                            this.$message.error(response.data.message || '获取分支信息失败');
                        }
                    })
                    .catch(error => {
                        this.$message.error('网络请求失败');
                        console.error(error);
                    })
                    .finally(() => {
                        this.editBranchLoading = false;
                    });
            },

            // 填充操作人
            fillOperator() {
                const operator = localStorage.getItem('operator');
                if (operator) {
                    this.editBranchForm.createBy = operator;
                    this.$message.success('已填充操作人信息');
                } else {
                    this.$message.warning('请先登录设置操作人');
                }
            },

            // 保存编辑分支
            handleSaveEditBranch() {
                this.$refs.editBranchForm.validate((valid) => {
                    if (valid) {
                        // 手动验证分支备注
                        if (!this.editBranchForm.branchDesc || this.editBranchForm.branchDesc.trim() === '') {
                            this.$message.error('请输入分支备注');
                            return;
                        }

                        this.saveEditBranchLoading = true;

                        const params = {
                            branchId: this.editBranchForm.branchId,
                            branchDesc: this.editBranchForm.branchDesc.trim(),
                            operator: this.editBranchForm.createBy
                        };

                        axios.post('/api/v1/git-merge-flow/updateGitBranch', params)
                            .then(response => {
                                if (response?.data?.code === 200) {
                                    this.$message.success('编辑成功');
                                    this.editBranchVisible = false;
                                    this.loadData(); // 刷新分页列表
                                } else {
                                    this.$message.error(response.data.message || '编辑失败');
                                }
                            })
                            .catch(error => {
                                this.$message.error('网络请求失败');
                                console.error(error);
                            })
                            .finally(() => {
                                this.saveEditBranchLoading = false;
                            });
                    }
                });
            },

            // 拉取远程分支
            handlePullRemoteBranch() {
                this.pullRemoteLoading = true;

                const params = {
                    gitProjectId: this.projectId
                };

                axios.post('/api/v1/git-merge-flow/pullRemoteBranch', params)
                    .then(response => {
                        if (response?.data?.code === 200) {
                            this.$message.success('拉取远程分支成功');
                            this.loadData();
                        } else {
                            this.$message.error(response.data.message || '拉取远程分支失败');
                        }
                    })
                    .catch(error => {
                        this.$message.error('网络请求失败');
                        console.error(error);
                    })
                    .finally(() => {
                        this.pullRemoteLoading = false;
                    });
            },

            // 回车键事件处理
            handleEnterKey() {
                this.handleSearch();
            },

            // 搜索
            handleSearch(event) {
                if (event) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                this.searchLoading = true;
                this.pagination.current = 1;
                this.loadData();
            },

            // 重置
            handleReset() {
                this.searchForm.branchName = '';
                this.pagination.current = 1;
                this.loadData();
            },

            // 初始化操作人
            initOperator() {
                const operator = localStorage.getItem('operator');
                if (operator) {
                    this.operatorButtonText = operator;
                } else {
                    this.operatorButtonText = '登录';
                }
            },

            // 操作人登录
            handleOperatorLogin() {
                const operator = localStorage.getItem('operator');
                this.operatorForm.operator = operator || '';
                this.operatorLoginVisible = true;
            },

            // 回车键保存操作人
            handleEnterKeySave(event) {
                // 彻底阻止所有默认行为
                if (event) {
                    event.preventDefault();
                    event.stopPropagation();
                    event.stopImmediatePropagation();
                    
                    // 阻止表单提交
                    if (event.target && event.target.form) {
                        event.target.form.onsubmit = function() { return false; };
                    }
                }
                
                // 延迟执行保存，确保事件完全处理完毕
                this.$nextTick(() => {
                    this.handleSaveOperator();
                });
            },

            // 关闭操作人对话框
            handleCloseOperatorDialog() {
                this.operatorLoginVisible = false;
            },

            // 保存操作人
            handleSaveOperator() {
                // 手动验证操作人输入
                if (!this.operatorForm.operator || this.operatorForm.operator.trim() === '') {
                    this.$message.error('请输入操作人');
                    return;
                }
                
                // 保存到localStorage
                localStorage.setItem('operator', this.operatorForm.operator.trim());
                this.operatorButtonText = this.operatorForm.operator.trim();
                this.operatorLoginVisible = false;
                this.$message.success('操作人设置成功');
            },

            // 添加全局回车键事件处理
            addGlobalEnterKeyHandler() {
                document.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        // 检查当前焦点是否在允许回车键的输入框上
                        const activeElement = document.activeElement;
                        const isBranchNameInput = activeElement && 
                            activeElement.getAttribute('placeholder') === '请输入分支名称';
                        const isOperatorInput = activeElement && 
                            activeElement.getAttribute('placeholder') === '请输入操作人';
                        
                        // 如果不在允许的输入框上，阻止回车键事件
                        if (!isBranchNameInput && !isOperatorInput) {
                            event.preventDefault();
                            event.stopPropagation();
                        }
                    }
                });
            },

            // 行样式：被勾选的行设置高亮底色
            branchRowClassName({ row }) {
                if (!this.selectedBranches || this.selectedBranches.length === 0) {
                    return '';
                }
                const found = this.selectedBranches.find(sel => sel && row && sel.branchName === row.branchName);
                return found ? 'row-selected' : '';
            }
        }
    });
</script>
</body>
</html>