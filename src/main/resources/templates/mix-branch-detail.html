<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{documentTitle}}</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="256x256" href="/favicon-256x256.png">
    <link rel="icon" type="image/png" sizes="128x128" href="/favicon-128x128.png">
    <link rel="icon" type="image/png" sizes="64x64" href="/favicon-64x64.png">
    <link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <!-- Element UI CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow-x: hidden;
        }

        #app {
            margin: 0;
            padding: 0;
            width: 100%;
            min-height: 100vh;
        }

        [v-cloak] {
            display: none !important;
        }

        .page-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-content {
            text-align: center;
            color: #409eff;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #409eff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .commit-message-container {
            position: relative;
            display: flex;
            align-items: center;
            max-width: 100%;
        }

        .commit-message-text {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            line-height: 1.4;
            max-height: 4.2em;
        }

        .commit-message-icon {
            margin-left: 8px;
            cursor: pointer;
            color: #409eff;
            font-size: 14px;
            flex-shrink: 0;
        }

        .commit-message-icon:hover {
            color: #66b1ff;
        }

        .header {
            background-color: #545c64;
            color: #fff;
            line-height: 60px;
            padding: 0 20px;
            font-size: 20px;
            font-weight: bold;
        }

        .container {
            display: flex;
            height: calc(100vh - 60px);
        }

        .sidebar {
            width: 200px;
            background-color: #324157;
        }

        .main-content {
            flex: 1;
            padding: 10px;
            background-color: #f5f5f5;
            overflow-y: auto;
        }

        .content-card {
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, .12), 0 0 6px rgba(0, 0, 0, .04);
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            padding: 20px 20px 10px;
            border-bottom: 1px solid #e6e6e6;
        }

        .section-content {
            padding: 20px;
        }

        .to-mix-branches-container {
            padding: 20px;
        }


        .mixed-branches-container {
            padding: 20px;
        }

        .page-title {
            margin-bottom: 20px;
            font-size: 24px;
            font-weight: bold;
            color: #303133;
        }

        .status-item {
            display: flex;
            margin-bottom: 10px;
        }

        .status-label {
            width: 80px;
            font-weight: bold;
        }

        .status-success {
            color: #67c23a;
        }

        .status-fail {
            color: #f56c6c;
        }

        .search-form {
            padding: 20px;
            border-bottom: 1px solid #e6e6e6;
        }

        .shell-dialog {
            border-radius: 12px;
            overflow: hidden;
        }

        .shell-dialog .el-dialog__header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            padding: 20px 30px;
            margin: 0;
        }

        .shell-dialog .el-dialog__title {
            color: #fff;
            font-weight: 600;
            font-size: 18px;
        }

        .shell-dialog .el-dialog__headerbtn .el-dialog__close {
            color: #fff;
            font-size: 20px;
        }

        .shell-dialog .el-dialog__body {
            padding: 0;
            background: #f8fafc;
        }

        .shell-content {
            background: #1a1d29;
            color: #e2e8f0;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', 'Source Code Pro', monospace;
            margin: 0;
            min-height: 400px;
            max-height: 70vh;
            overflow-y: auto;
            position: relative;
        }

        .shell-header {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: #fff;
            padding: 20px 30px;
            font-weight: 600;
            font-size: 15px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .shell-header i {
            margin-right: 12px;
            font-size: 18px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
            }
        }

        .shell-commands {
            padding: 30px;
            background: #1a1d29;
        }

        .shell-line {
            display: flex;
            align-items: flex-start;
            margin-bottom: 16px;
            padding: 16px 20px;
            background: #2d3748;
            border-radius: 10px;
            border-left: 4px solid #10b981;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .shell-line::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.5), transparent);
        }

        .shell-line:hover {
            background: #374151;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border-left-color: #3b82f6;
        }

        .shell-text {
            flex: 1;
            margin-right: 15px;
            font-size: 14px;
            line-height: 1.6;
            word-break: break-all;
            color: #f1f5f9;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .copy-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: none;
            color: #fff;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
            position: relative;
            overflow: hidden;
        }

        .copy-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .copy-btn:hover::before {
            left: 100%;
        }

        .copy-btn:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .copy-btn:active {
            transform: translateY(0);
        }

        .copy-btn i {
            margin-right: 6px;
            font-size: 14px;
        }

        .copy-success {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);
        }

        .empty-state {
            text-align: center;
            padding: 60px 30px;
            color: #64748b;
            background: #2d3748;
            margin: 30px;
            border-radius: 12px;
            border: 2px dashed #475569;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 20px;
            display: block;
            color: #475569;
        }

        .empty-state p {
            margin: 0;
            font-size: 16px;
            font-weight: 500;
        }

        .shell-footer {
            background: #374151;
            padding: 20px 30px;
            text-align: center;
            border-top: 1px solid #4b5563;
        }

        .shell-footer .footer-text {
            color: #9ca3af;
            font-size: 13px;
            margin: 0;
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        .shell-content::-webkit-scrollbar {
            width: 8px;
        }

        .shell-content::-webkit-scrollbar-track {
            background: #374151;
        }

        .shell-content::-webkit-scrollbar-thumb {
            background: #6b7280;
            border-radius: 4px;
        }

        .shell-content::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        /* æ–°å¢çš„UIå…ƒç´ æ ·å¼ */


        .line-number {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 700;
            font-size: 13px;
            margin-right: 16px;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
        }

        .empty-state span {
            display: block;
            margin-top: 8px;
            font-size: 14px;
            color: #6b7280;
        }

        .commit-info {
            font-size: 12px;
            color: #909399;
            line-height: 1.5;
        }

        .commit-info .commit-message-container {
            display: flex;
            align-items: flex-start;
            margin-top: 2px;
        }

        .commit-info .commit-message-container span {
            flex-shrink: 0;
            margin-right: 4px;
        }

        .commit-info .commit-message-text {
            flex: 1;
            min-width: 0;
        }

        .merge-status-success {
            color: #67c23a;
        }

        .merge-status-fail {
            color: #f56c6c;
        }
    </style>
</head>
<body>
<!-- åˆå§‹åŠ è½½é¡µé¢ -->
<div id="page-loading" class="page-loading">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <div>æ­£åœ¨åŠ è½½é¡µé¢...</div>
    </div>
</div>

<div id="app" v-cloak>
    <!-- å¤´éƒ¨ -->
    <div class="header">
        <span>Gitåˆæµç®¡ç†ç³»ç»Ÿ</span>
        <div style="float: right;">
            <el-button type="primary" @click="handleOperatorLogin">{{operatorButtonText}}</el-button>
        </div>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="container">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar">
            <el-menu
                    default-active="1"
                    class="el-menu-vertical"
                    background-color="#324157"
                    text-color="#bfcbd9"
                    active-text-color="#409EFF"
                    @select="handleMenuSelect">
                <el-menu-item index="1">
                    <i class="el-icon-files"></i>
                    <span slot="title">Gitå·¥ç¨‹ç®¡ç†</span>
                </el-menu-item>
                <el-menu-item index="2">
                    <i class="el-icon-office-building"></i>
                    <span slot="title">Gitç»„ç»‡ç®¡ç†</span>
                </el-menu-item>
            </el-menu>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content" v-loading="pageLoading" element-loading-text="æ­£åœ¨åŠ è½½é¡µé¢æ•°æ®..."
             element-loading-spinner="el-icon-loading">
            <div class="page-title">{{pageTitle}}ä¸­é—´åˆ†æ”¯</div>

            <!-- åˆå¹¶çŠ¶æ€ -->
            <div class="content-card">
                <div class="section-title">åˆå¹¶çŠ¶æ€</div>
                <div class="section-content">
                    <div style="display: flex;">
                        <div style="flex: 1; margin-right: 40px;">
                            <div class="status-item">
                                <span class="status-label">åˆå¹¶åˆ†æ”¯ï¼š</span>
                                <span>{{branchDetail.mixBranchName}}</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">åˆå¹¶çŠ¶æ€ï¼š</span>
                                <span v-if="branchDetail.allMergeFlag === 1" class="status-success">è‡ªåŠ¨åˆå¹¶æˆåŠŸ</span>
                                <span v-else>
                                        <span class="status-fail">è‡ªåŠ¨åˆå¹¶å¤±è´¥</span>
                                        <el-button type="primary" size="mini" @click="showConflictShell"
                                                   style="margin-left: 10px;">æ‰‹åŠ¨å¤„ç†å†²çª</el-button>
                                    </span>
                            </div>
                        </div>
                        <div style="flex: 1; margin-right: 40px;">
                            <div class="status-item">
                                <span class="status-label">åˆå¹¶æ—¶é—´ï¼š</span>
                                <span>{{branchDetail.updateTime}}</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">æ“ä½œç”¨æˆ·ï¼š</span>
                                <span>{{branchDetail.updateBy}}</span>
                            </div>
                        </div>
                        <div style="flex: 0 0 auto;">
                            <el-button type="primary" @click="handleRemerge" :loading="remergeLoading">é‡æ–°åˆå¹¶
                            </el-button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å½“å‰é›†æˆåˆ†æ”¯ -->
            <div class="content-card">
                <div class="section-title">å½“å‰é›†æˆåˆ†æ”¯</div>
                <div class="search-form">
                    <div class="demo-form-inline" style="display: flex; align-items: center; gap: 10px;">
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <label>åˆ†æ”¯å</label>
                            <el-input v-model="mixedSearchForm.branchName" placeholder="è¯·è¾“å…¥åˆ†æ”¯å"
                                      clearable style="width: 200px;"></el-input>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <el-button type="primary" @click="searchMixedBranches">æœç´¢</el-button>
                            <el-button type="danger" @click="handleBatchRemove"
                                       :disabled="selectedMixedBranches.length === 0"
                                       :loading="batchRemoveLoading">æ‰¹é‡é€€å‡º
                            </el-button>
                        </div>
                    </div>
                </div>
                <div class="mixed-branches-container">
                    <el-table
                            :data="mixedBranches"
                            v-loading="mixedBranchesLoading"
                            @selection-change="handleMixedSelectionChange"
                            style="width: 100%"
                            element-loading-text="æ­£åœ¨åŠ è½½ä¸­..."
                            element-loading-spinner="el-icon-loading">
                        <el-table-column type="selection" width="55"></el-table-column>
                        <el-table-column prop="branchName" label="åˆ†æ”¯å" width="300"></el-table-column>
                        <el-table-column prop="branchDesc" label="åˆ†æ”¯æè¿°" min-width="150"></el-table-column>
                        <el-table-column prop="createBy" label="åˆ›å»ºäºº" width="100"></el-table-column>
                        <el-table-column label="åˆå¹¶çŠ¶æ€" width="100">
                            <template slot-scope="scope">
                                <span v-if="scope.row.mergeStatus === 1" class="merge-status-success">æˆåŠŸ</span>
                                <span v-else class="merge-status-fail">å¤±è´¥</span>
                            </template>
                        </el-table-column>
                        <el-table-column label="æœ€è¿‘æäº¤ä¿¡æ¯" min-width="200">
                            <template slot-scope="scope">
                                <div class="commit-info">
                                    <div>æ—¶é—´ï¼š{{scope.row.lastCommitTime}}</div>
                                    <div>IDï¼š{{scope.row.lastCommitShortId}}</div>
                                    <div>æäº¤äººï¼š{{scope.row.lastCommitUser}}</div>
                                    <div class="commit-message-container">
                                        <span>å†…å®¹ï¼š</span>
                                        <div class="commit-message-text">{{scope.row.lastCommitMessage}}</div>
                                        <el-tooltip
                                                v-if="scope.row.lastCommitMessage && scope.row.lastCommitMessage.length > 120"
                                                :content="scope.row.lastCommitMessage"
                                                placement="top"
                                                effect="dark">
                                            <i class="el-icon-info commit-message-icon"></i>
                                        </el-tooltip>
                                    </div>
                                </div>
                            </template>
                        </el-table-column>
                        <el-table-column label="æ“ä½œ" width="100">
                            <template slot-scope="scope">
                                <el-button size="mini" type="danger" @click="handleRemoveBranch(scope.row)">é€€å‡º
                                </el-button>
                            </template>
                        </el-table-column>
                    </el-table>
                </div>
            </div>

            <!-- å¾…é›†æˆåˆ†æ”¯ -->
            <div class="content-card">
                <div class="section-title">å¾…é›†æˆåˆ†æ”¯</div>
                <div class="search-form">
                    <div class="demo-form-inline" style="display: flex; align-items: center; gap: 10px;">
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <label>åˆ†æ”¯å</label>
                            <el-input v-model="toMixSearchForm.branchName" placeholder="è¯·è¾“å…¥åˆ†æ”¯å"
                                      clearable style="width: 200px;"></el-input>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <el-button type="primary" @click="searchToMixBranches">æœç´¢</el-button>
                            <el-button type="success" @click="handleBatchAdd"
                                       :disabled="selectedToMixBranches.length === 0" :loading="batchAddLoading">æ‰¹é‡åŠ å…¥
                            </el-button>
                            <el-button type="primary" @click="handleCreateBranch">æ–°å»ºåˆ†æ”¯</el-button>
                            <el-button type="danger" @click="handleBatchClean"
                                       :disabled="selectedToMixBranches.length === 0" :loading="batchCleanLoading">åˆ†æ”¯æ¸…ç†
                            </el-button>
                        </div>
                    </div>
                </div>
                <div class="to-mix-branches-container">
                    <el-table
                            :data="toMixBranches"
                            v-loading="toMixBranchesLoading"
                            @selection-change="handleToMixSelectionChange"
                            style="width: 100%"
                            :height="toMixTableHeight"
                            element-loading-text="æ­£åœ¨åŠ è½½ä¸­..."
                            element-loading-spinner="el-icon-loading">
                        <el-table-column type="selection" width="55"></el-table-column>
                        <el-table-column prop="branchName" label="åˆ†æ”¯å" width="300"></el-table-column>
                        <el-table-column prop="branchDesc" label="åˆ†æ”¯æè¿°" min-width="150"></el-table-column>
                        <el-table-column prop="createBy" label="åˆ›å»ºäºº" width="100"></el-table-column>
                        <el-table-column label="æœ€è¿‘æäº¤ä¿¡æ¯" min-width="200">
                            <template slot-scope="scope">
                                <div class="commit-info">
                                    <div>æ—¶é—´ï¼š{{scope.row.lastCommitTime}}</div>
                                    <div>IDï¼š{{scope.row.lastCommitShortId}}</div>
                                    <div>æäº¤äººï¼š{{scope.row.lastCommitUser}}</div>
                                    <div class="commit-message-container">
                                        <span>å†…å®¹ï¼š</span>
                                        <div class="commit-message-text">{{scope.row.lastCommitMessage}}</div>
                                        <el-tooltip
                                                v-if="scope.row.lastCommitMessage && scope.row.lastCommitMessage.length > 120"
                                                :content="scope.row.lastCommitMessage"
                                                placement="top"
                                                effect="dark">
                                            <i class="el-icon-info commit-message-icon"></i>
                                        </el-tooltip>
                                    </div>
                                </div>
                            </template>
                        </el-table-column>
                        <el-table-column label="æ“ä½œ" width="200">
                            <template slot-scope="scope">
                                <el-button size="mini" type="primary" @click="handleAddBranch(scope.row)">åŠ å…¥
                                </el-button>
                                <el-button size="mini" type="danger" @click="handleCleanBranch(scope.row)">æ¸…ç†åˆ†æ”¯
                                </el-button>
                            </template>
                        </el-table-column>
                    </el-table>
                </div>
            </div>
        </div>
    </div>

    <!-- å†²çªå¤„ç†Shellå‘½ä»¤å¼¹çª— -->
    <el-dialog title="ğŸ”§ æ‰‹åŠ¨å¤„ç†å†²çªå‘½ä»¤" :visible.sync="shellVisible" width="85%" class="shell-dialog"
               :before-close="handleShellDialogClose">
        <div class="shell-content">
            <!-- æç¤ºä¿¡æ¯ -->
            <div class="shell-header">
                <i class="el-icon-warning"></i>
                è‡ªåŠ¨åˆå¹¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤„ç†å†²çªï¼Œå†é‡æ–°åˆå¹¶
            </div>

            <!-- å‘½ä»¤åˆ—è¡¨ -->
            <div class="shell-commands">
                <div v-for="(line, index) in shellLines" :key="index" class="shell-line">
                    <div class="line-number">{{index + 1}}</div>
                    <div class="shell-text">{{line}}</div>
                    <button class="copy-btn" @click="copyToClipboard(line, index)" :ref="'copyBtn' + index">
                        <i class="el-icon-document-copy"></i> å¤åˆ¶
                    </button>
                </div>

                <!-- ç©ºçŠ¶æ€æç¤º -->
                <div v-if="!shellLines || shellLines.length === 0" class="empty-state">
                    <i class="el-icon-warning-outline"></i>
                    <p>æš‚æ— å†²çªå¤„ç†å‘½ä»¤</p>
                    <span>è¯·æ£€æŸ¥åç«¯æ¥å£è¿”å›æ•°æ®</span>
                </div>
            </div>

            <!-- é¡µè„šæç¤º -->
            <div class="shell-footer" v-if="shellLines && shellLines.length > 0">
                <p class="footer-text">
                    <i class="el-icon-lightbulb"></i>
                    æ‰§è¡Œå®Œæ‰€æœ‰å‘½ä»¤åï¼Œè¯·è¿”å›é¡µé¢ç‚¹å‡»"é‡æ–°åˆå¹¶"æŒ‰é’®ç»§ç»­æ“ä½œ
                </p>
            </div>
        </div>
    </el-dialog>

    <!-- æ–°å»ºåˆ†æ”¯å¼¹çª— -->
    <el-dialog title="æ–°å»ºåˆ†æ”¯" :visible.sync="createBranchVisible" width="500px">
        <el-form :model="createBranchForm" :rules="createBranchRules" ref="createBranchForm" label-width="100px">
            <el-form-item label="Gitå·¥ç¨‹">
                <el-input :value="projectName" disabled></el-input>
            </el-form-item>
            <el-form-item label="æ¥æºåˆ†æ”¯" prop="sourceBranch">
                <el-select v-model="createBranchForm.sourceBranch" placeholder="è¯·é€‰æ‹©æ¥æºåˆ†æ”¯" style="width: 100%">
                    <el-option
                            v-for="branch in sourceBranches"
                            :key="branch.branchName"
                            :label="branch.branchName"
                            :value="branch.branchName">
                    </el-option>
                </el-select>
            </el-form-item>
            <el-form-item label="åˆ†æ”¯åç§°" prop="branchName">
                <el-input v-model="createBranchForm.branchName" placeholder="è¯·è¾“å…¥åˆ†æ”¯åç§°" maxlength="100"></el-input>
            </el-form-item>
            <el-form-item label="åˆ†æ”¯æè¿°" prop="branchDesc">
                <el-input v-model="createBranchForm.branchDesc" placeholder="è¯·è¾“å…¥åˆ†æ”¯æè¿°" maxlength="200"
                          type="textarea"></el-input>
            </el-form-item>
        </el-form>
        <div slot="footer" class="dialog-footer">
            <el-button @click="createBranchVisible = false">å–æ¶ˆ</el-button>
            <el-button type="primary" @click="handleSaveBranch" :loading="saveBranchLoading">ä¿å­˜</el-button>
        </div>
    </el-dialog>

    <!-- æ“ä½œäººç™»å½•å¼¹çª— -->
    <el-dialog title="æ“ä½œäººç™»å½•" :visible.sync="operatorLoginVisible" width="400px" :close-on-click-modal="false" :close-on-press-escape="false">
        <div style="padding: 20px;">
            <div style="display: flex; align-items: center; margin-bottom: 20px;">
                <label style="width: 80px; text-align: right; margin-right: 10px;">æ“ä½œäººï¼š</label>
                <el-input v-model="operatorForm.operator" placeholder="è¯·è¾“å…¥æ“ä½œäºº" 
                          @keyup.enter.native="handleEnterKeySave" style="flex: 1;"></el-input>
            </div>
        </div>
        <div slot="footer" class="dialog-footer">
            <el-button @click="handleCloseOperatorDialog">å…³é—­</el-button>
            <el-button type="primary" @click="handleSaveOperator">ä¿å­˜</el-button>
        </div>
    </el-dialog>
</div>

<!-- Vueå’ŒElement UI -->
<script src="https://unpkg.com/vue@2/dist/vue.js"></script>
<script src="https://unpkg.com/element-ui/lib/index.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

<script>
    new Vue({
        el: '#app',
        data() {
            return {
                mixBranchId: null,
                projectId: null,
                projectName: '',
                env: '',
                pageTitle: '',
                documentTitle: 'ä¸­é—´åˆ†æ”¯è¯¦æƒ… - Gitåˆæµç®¡ç†ç³»ç»Ÿ',
                branchDetail: {},
                mixedBranches: null,
                toMixBranches: null,
                selectedMixedBranches: [],
                selectedToMixBranches: [],
                mixedSearchForm: {
                    branchName: ''
                },
                toMixSearchForm: {
                    branchName: ''
                },
                shellVisible: false,
                shellLines: [],
                remergeLoading: false,
                mixedBranchesLoading: false,
                toMixBranchesLoading: false,
                pageLoading: false,
                removeBranchLoading: false,
                batchRemoveLoading: false,
                addBranchLoading: false,
                batchAddLoading: false,
                cleanBranchLoading: false,
                batchCleanLoading: false,
                saveBranchLoading: false,
                windowHeight: window.innerHeight,
                createBranchVisible: false,
                createBranchForm: {
                    sourceBranch: '',
                    branchName: '',
                    branchDesc: ''
                },
                createBranchRules: {
                    sourceBranch: [
                        {required: true, message: 'è¯·é€‰æ‹©æ¥æºåˆ†æ”¯', trigger: 'change'}
                    ],
                    branchName: [
                        {required: true, message: 'è¯·è¾“å…¥åˆ†æ”¯åç§°', trigger: 'blur'},
                        {max: 100, message: 'é•¿åº¦ä¸èƒ½è¶…è¿‡100å­—ç¬¦', trigger: 'blur'}
                    ],
                    branchDesc: [
                        {max: 200, message: 'é•¿åº¦ä¸èƒ½è¶…è¿‡200å­—ç¬¦', trigger: 'blur'}
                    ]
                },
                sourceBranches: [],
                // æ“ä½œäººç›¸å…³
                operatorLoginVisible: false,
                operatorForm: {
                    operator: ''
                },
                operatorButtonText: 'ç™»å½•'
            }
        },
        watch: {
            // ç›‘å¬æ–‡æ¡£æ ‡é¢˜å˜åŒ–
            documentTitle: {
                handler(newTitle) {
                    if (newTitle) {
                        document.title = newTitle;
                    }
                },
                immediate: true
            },
            // ç›‘å¬æ•°æ®å˜åŒ–ï¼Œé‡æ–°è®¡ç®—è¡¨æ ¼é«˜åº¦
            mixedBranches: {
                handler() {
                    this.$nextTick(() => {
                        this.updateTableHeight();
                    });
                },
                deep: true
            },
            toMixBranches: {
                handler() {
                    this.$nextTick(() => {
                        this.updateTableHeight();
                    });
                },
                deep: true
            }
        },
        computed: {
            // è®¡ç®—å¾…é›†æˆåˆ†æ”¯è¡¨æ ¼çš„åŠ¨æ€é«˜åº¦
            toMixTableHeight() {
                // ä½¿ç”¨å®é™…DOMè®¡ç®—é«˜åº¦ï¼Œç¡®ä¿ç²¾ç¡®é€‚é…
                return this.calculateTableHeight();
            }
        },
        mounted() {
            // éšè—åˆå§‹loadingé¡µé¢
            const pageLoading = document.getElementById('page-loading');
            if (pageLoading) {
                pageLoading.style.display = 'none';
            }

            this.initOperator();
            this.initPage();
            this.loadData();

                        // ç›‘å¬çª—å£å¤§å°å˜åŒ–
            window.addEventListener('resize', this.handleWindowResize);
            
            // é˜²æ­¢é¡µé¢æ„å¤–åˆ·æ–°
            this.handleBeforeUnload = (event) => {
                // å¦‚æœæ“ä½œäººå¯¹è¯æ¡†æ‰“å¼€ï¼Œé˜»æ­¢é¡µé¢åˆ·æ–°
                if (this.operatorLoginVisible) {
                    event.preventDefault();
                    event.returnValue = '';
                }
            };
            window.addEventListener('beforeunload', this.handleBeforeUnload);
            
            // åˆå§‹åŒ–å®Œæˆåè®¡ç®—è¡¨æ ¼é«˜åº¦
            this.$nextTick(() => {
                setTimeout(() => {
                    this.updateTableHeight();
                }, 500); // å»¶è¿Ÿç¡®ä¿DOMå®Œå…¨æ¸²æŸ“
            });
        },
        beforeDestroy() {
            // ç§»é™¤çª—å£å¤§å°å˜åŒ–ç›‘å¬å™¨
            window.removeEventListener('resize', this.handleWindowResize);
            // ç§»é™¤é¡µé¢åˆ·æ–°ç›‘å¬å™¨
            window.removeEventListener('beforeunload', this.handleBeforeUnload);
        },
        methods: {
            // å¤„ç†çª—å£å¤§å°å˜åŒ–
            handleWindowResize() {
                this.windowHeight = window.innerHeight;
                // å»¶è¿Ÿé‡æ–°è®¡ç®—é«˜åº¦ï¼Œç¡®ä¿DOMå·²æ›´æ–°
                this.$nextTick(() => {
                    this.updateTableHeight();
                });
            },

            // è®¡ç®—è¡¨æ ¼é«˜åº¦
            calculateTableHeight() {
                try {
                    // è·å–é¡µé¢æ€»é«˜åº¦
                    const viewportHeight = this.windowHeight || window.innerHeight;

                    // è®¡ç®—å·²å ç”¨çš„é«˜åº¦
                    let usedHeight = 0;

                    // é¡¶éƒ¨å¯¼èˆªæ å’Œèœå•æ 
                    const header = document.querySelector('.el-header') || document.querySelector('header') || document.querySelector('nav');
                    if (header) {
                        usedHeight += header.offsetHeight;
                    } else {
                        usedHeight += 60; // é»˜è®¤å€¼
                    }

                    // é¡µé¢æ ‡é¢˜
                    const titleElement = document.querySelector('.page-title');
                    if (titleElement) {
                        usedHeight += titleElement.offsetHeight + 20; // åŒ…å«margin
                    } else {
                        usedHeight += 80; // é»˜è®¤å€¼
                    }

                    // åˆå¹¶çŠ¶æ€åŒºåŸŸ
                    const statusCard = document.querySelector('.content-card:first-of-type');
                    if (statusCard) {
                        usedHeight += statusCard.offsetHeight + 20; // åŒ…å«margin
                    } else {
                        usedHeight += 200; // é»˜è®¤å€¼
                    }

                    // å½“å‰é›†æˆåˆ†æ”¯åŒºåŸŸï¼ˆåŠ¨æ€è®¡ç®—ï¼‰
                    const mixedCard = document.querySelector('.content-card:nth-of-type(2)');
                    if (mixedCard) {
                        usedHeight += mixedCard.offsetHeight + 20; // åŒ…å«margin
                    } else {
                        // å¦‚æœDOMè¿˜æœªæ¸²æŸ“ï¼Œä½¿ç”¨åŠ¨æ€ä¼°ç®—
                        const mixedBranchCount = this.mixedBranches ? this.mixedBranches.length : 0;
                        const mixedBranchHeight = Math.min(mixedBranchCount * 60 + 160, 400);
                        usedHeight += mixedBranchHeight;
                    }

                    // å¾…é›†æˆåˆ†æ”¯æœç´¢åŒºåŸŸ
                    const searchForm = document.querySelector('.content-card:last-of-type .search-form');
                    if (searchForm) {
                        usedHeight += searchForm.offsetHeight + 20; // åŒ…å«margin
                    } else {
                        usedHeight += 80; // é»˜è®¤å€¼
                    }

                    // é¢„ç•™åº•éƒ¨ç©ºé—´
                    usedHeight += 40;

                    // è®¡ç®—å¯ç”¨é«˜åº¦
                    const availableHeight = viewportHeight - usedHeight;

                    // è®¾ç½®åˆç†çš„æœ€å°å’Œæœ€å¤§å€¼
                    const minHeight = 200;
                    const maxHeight = 600;

                    return Math.max(minHeight, Math.min(availableHeight, maxHeight));
                } catch (error) {
                    console.error('è®¡ç®—è¡¨æ ¼é«˜åº¦å¤±è´¥:', error);
                    return 300; // å…œåº•å€¼
                }
            },

            // æ›´æ–°è¡¨æ ¼é«˜åº¦ï¼ˆç”¨äºçª—å£å¤§å°å˜åŒ–æ—¶ï¼‰
            updateTableHeight() {
                // å¼ºåˆ¶è§¦å‘computedé‡æ–°è®¡ç®—
                this.$forceUpdate();
            },

            // åˆå§‹åŒ–é¡µé¢
            initPage() {
                const urlParams = new URLSearchParams(window.location.search);
                this.mixBranchId = urlParams.get('mixBranchId');
                this.projectId = urlParams.get('projectId');
                this.projectName = urlParams.get('projectName') || '';
                this.env = urlParams.get('env') || '';
                this.pageTitle = `${this.projectName}-${this.env}`;

                // æ›´æ–°é¡µé¢æ ‡é¢˜
                if (this.projectName && this.env) {
                    this.documentTitle = `${this.projectName}-${this.env}ä¸­é—´åˆ†æ”¯ - Gitåˆæµç®¡ç†ç³»ç»Ÿ`;
                    // åŒæ—¶æ›´æ–°æµè§ˆå™¨æ ‡é¢˜
                    document.title = this.documentTitle;
                }
            },

            // åŠ è½½æ•°æ®
            loadData() {
                if (!this.mixBranchId) {
                    this.$message.error('ä¸­é—´åˆ†æ”¯IDä¸èƒ½ä¸ºç©º');
                    return;
                }

                this.pageLoading = true;
                this.mixedBranchesLoading = true;
                this.toMixBranchesLoading = true;

                const params = {
                    mixBranchId: this.mixBranchId
                };

                axios.post('/api/v1/git-merge-flow/queryMixBranch', params)
                    .then(response => {
                        if (response?.data?.code === 200) {
                            this.branchDetail = response.data.data;
                            this.mixedBranches = response.data.data.mixedBranchVoList || [];
                            this.toMixBranches = response.data.data.toMixBranchVoList || [];
                        } else {
                            this.$message.error(response.data.message || 'æŸ¥è¯¢å¤±è´¥');
                        }
                    })
                    .catch(error => {
                        this.$message.error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
                        console.error(error);
                    })
                    .finally(() => {
                        this.pageLoading = false;
                        this.mixedBranchesLoading = false;
                        this.toMixBranchesLoading = false;

                        // æ•°æ®åŠ è½½å®Œæˆåé‡æ–°è®¡ç®—è¡¨æ ¼é«˜åº¦
                        this.$nextTick(() => {
                            this.updateTableHeight();
                        });
                    });
            },

            // èœå•é€‰æ‹©
            handleMenuSelect(key) {
                if (key === '1') {
                    window.location.href = '/project';
                } else if (key === '2') {
                    window.location.href = '/organization';
                }
            },

            // æ˜¾ç¤ºå†²çªå¤„ç†å‘½ä»¤
            showConflictShell() {
                if (this.branchDetail.userMergeShell) {
                    // è¿‡æ»¤æ‰ç©ºè¡Œå’ŒåªåŒ…å«ç©ºç™½å­—ç¬¦çš„è¡Œ
                    this.shellLines = this.branchDetail.userMergeShell
                        .split('\n')
                        .map(line => line.trim())
                        .filter(line => line.length > 0);
                    this.shellVisible = true;
                } else {
                    this.$message.warning('æš‚æ— å†²çªå¤„ç†å‘½ä»¤');
                }
            },

            // å¤åˆ¶åˆ°å‰ªè´´æ¿
            copyToClipboard(text, index) {
                if (!text || text.trim() === '') {
                    this.$message.warning('å¤åˆ¶å†…å®¹ä¸ºç©º');
                    return;
                }

                if (navigator.clipboard && window.isSecureContext) {
                    // ç°ä»£æµè§ˆå™¨API
                    navigator.clipboard.writeText(text.trim()).then(() => {
                        this.$message({
                            message: 'å‘½ä»¤å·²å¤åˆ¶åˆ°å‰ªè´´æ¿',
                            type: 'success',
                            duration: 2000,
                            showClose: true
                        });
                        this.showCopySuccess(index);
                    }).catch(err => {
                        console.error('å¤åˆ¶å¤±è´¥:', err);
                        this.$message.error('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
                    });
                } else {
                    // å…¼å®¹æ—§æµè§ˆå™¨
                    try {
                        const textArea = document.createElement('textarea');
                        textArea.value = text.trim();
                        textArea.style.position = 'fixed';
                        textArea.style.opacity = '0';
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();

                        const successful = document.execCommand('copy');
                        document.body.removeChild(textArea);

                        if (successful) {
                            this.$message({
                                message: 'å‘½ä»¤å·²å¤åˆ¶åˆ°å‰ªè´´æ¿',
                                type: 'success',
                                duration: 2000,
                                showClose: true
                            });
                            this.showCopySuccess(index);
                        } else {
                            throw new Error('execCommand failed');
                        }
                    } catch (err) {
                        console.error('å¤åˆ¶å¤±è´¥:', err);
                        this.$message.error('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
                    }
                }
            },


            // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæ•ˆæœ
            showCopySuccess(index) {
                if (typeof index !== 'undefined') {
                    const btnRef = this.$refs['copyBtn' + index];
                    if (btnRef && btnRef[0]) {
                        const btn = btnRef[0];
                        btn.classList.add('copy-success');
                        const originalText = btn.innerHTML;
                        btn.innerHTML = '<i class="el-icon-check"></i> å·²å¤åˆ¶';

                        setTimeout(() => {
                            btn.classList.remove('copy-success');
                            btn.innerHTML = originalText;
                        }, 2000);
                    }
                }
            },

            // å…³é—­å¼¹çª—äº‹ä»¶å¤„ç†
            handleShellDialogClose() {
                this.shellVisible = false;
            },

            // é‡æ–°åˆå¹¶
            handleRemerge() {
                const operator = localStorage.getItem('operator');
                if (!operator) {
                    this.$message.error('è¯·å…ˆç™»å½•è®¾ç½®æ“ä½œäºº');
                    return;
                }

                this.remergeLoading = true;
                const params = {
                    mixBranchId: this.mixBranchId,
                    operator: operator
                };

                axios.post('/api/v1/git-merge-flow/remergeMixBranch', params)
                    .then(response => {
                        if (response?.data?.code === 200) {
                            // remergeMixBranch æˆåŠŸï¼Œç›´æ¥è°ƒç”¨ queryMixBranch åˆ·æ–°é¡µé¢
                            this.refreshPageAndCheckStatus();
                        } else {
                            this.$message.error(response.data.message || 'é‡æ–°åˆå¹¶å¤±è´¥');
                        }
                    })
                    .catch(error => {
                        this.$message.error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
                        console.error(error);
                    })
                    .finally(() => {
                        this.remergeLoading = false;
                    });
            },

            // åˆ·æ–°é¡µé¢å¹¶æ£€æŸ¥åˆå¹¶çŠ¶æ€
            refreshPageAndCheckStatus() {
                if (!this.mixBranchId) {
                    this.$message.error('ä¸­é—´åˆ†æ”¯IDä¸èƒ½ä¸ºç©º');
                    return;
                }

                const params = {
                    mixBranchId: this.mixBranchId
                };

                axios.post('/api/v1/git-merge-flow/queryMixBranch', params)
                    .then(response => {
                        if (response?.data?.code === 200) {
                            // æ›´æ–°é¡µé¢æ•°æ®
                            this.branchDetail = response.data.data;
                            this.mixedBranches = response.data.data.mixedBranchVoList || [];
                            this.toMixBranches = response.data.data.toMixBranchVoList || [];

                            // æ£€æŸ¥åˆå¹¶çŠ¶æ€
                            const branchDetail = response.data.data;
                            if (branchDetail && branchDetail.allMergeFlag === 0) {
                                // flag=falseï¼Œè‡ªåŠ¨åˆå¹¶å¤±è´¥ï¼Œå¼¹å‡ºæ‰‹åŠ¨å¤„ç†å†²çªå‘½ä»¤é¡µé¢
                                if (branchDetail.userMergeShell) {
                                    this.showConflictShell();
                                } else {
                                    this.$message.warning('è‡ªåŠ¨åˆå¹¶å¤±è´¥ï¼Œä½†æœªè·å–åˆ°å†²çªå¤„ç†å‘½ä»¤');
                                }
                            } else if (branchDetail && branchDetail.allMergeFlag === 1) {
                                // flag=trueï¼Œè‡ªåŠ¨åˆå¹¶æˆåŠŸ
                                this.$message.success('è‡ªåŠ¨åˆå¹¶æˆåŠŸ');
                            }
                        } else {
                            this.$message.error(response.data.message || 'æŸ¥è¯¢å¤±è´¥');
                        }
                    })
                    .catch(error => {
                        this.$message.error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
                        console.error(error);
                    })
                    .finally(() => {
                        // æ•°æ®åŠ è½½å®Œæˆåé‡æ–°è®¡ç®—è¡¨æ ¼é«˜åº¦
                        this.$nextTick(() => {
                            this.updateTableHeight();
                        });
                    });
            },

            // æœç´¢å·²é›†æˆåˆ†æ”¯
            searchMixedBranches() {
                this.mixedBranchesLoading = true;

                const params = {
                    gitProjectId: this.projectId,
                    mixBranchId: this.mixBranchId,
                    branchName: this.mixedSearchForm.branchName || null
                };

                axios.post('/api/v1/git-merge-flow/listGitBranch', params)
                    .then(response => {
                        if (response?.data?.code === 200) {
                            this.mixedBranches = response.data.data;
                        } else {
                            this.$message.error('æœç´¢å¤±è´¥');
                        }
                    })
                    .catch(error => {
                        this.$message.error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
                        console.error(error);
                    })
                    .finally(() => {
                        this.mixedBranchesLoading = false;
                    });
            },

            // æœç´¢å¾…é›†æˆåˆ†æ”¯
            searchToMixBranches() {
                this.toMixBranchesLoading = true;

                const params = {
                    gitProjectId: this.projectId,
                    branchName: this.toMixSearchForm.branchName || null
                };

                axios.post('/api/v1/git-merge-flow/listGitBranch', params)
                    .then(response => {
                        if (response?.data?.code === 200) {
                            this.toMixBranches = response.data.data;
                        } else {
                            this.$message.error('æœç´¢å¤±è´¥');
                        }
                    })
                    .catch(error => {
                        this.$message.error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
                        console.error(error);
                    })
                    .finally(() => {
                        this.toMixBranchesLoading = false;
                    });
            },

            // å·²é›†æˆåˆ†æ”¯é€‰æ‹©æ”¹å˜
            handleMixedSelectionChange(val) {
                this.selectedMixedBranches = val;
            },

            // å¾…é›†æˆåˆ†æ”¯é€‰æ‹©æ”¹å˜
            handleToMixSelectionChange(val) {
                this.selectedToMixBranches = val;
            },

            // ç§»é™¤å•ä¸ªåˆ†æ”¯
            handleRemoveBranch(row) {
                this.$confirm('ç¡®è®¤å°†è¯¥åˆ†æ”¯ä»ä¸­é—´åˆ†æ”¯ä¸­é€€å‡ºå—ï¼Ÿ', 'æç¤º', {
                    confirmButtonText: 'ç¡®å®š',
                    cancelButtonText: 'å–æ¶ˆ',
                    type: 'warning'
                }).then(() => {
                    const operator = localStorage.getItem('operator');
                    if (!operator) {
                        this.$message.error('è¯·å…ˆç™»å½•è®¾ç½®æ“ä½œäºº');
                        return;
                    }

                    const params = {
                        mixBranchId: this.mixBranchId,
                        gitBranchNameList: [row.branchName],
                        operator: operator
                    };

                    axios.post('/api/v1/git-merge-flow/removeFromMixBranch', params)
                        .then(response => {
                            if (response?.data?.code === 200) {
                                // æ›´æ–°mixBranchId
                                if (response.data.data && response.data.data.mixBranchId) {
                                    this.mixBranchId = response.data.data.mixBranchId;
                                    this.updateUrlMixBranchId(this.mixBranchId);
                                }
                                this.$message.success('é€€å‡ºæˆåŠŸ');
                                this.loadData();
                            } else {
                                this.$message.error(response.data.message || 'é€€å‡ºå¤±è´¥');
                            }
                        })
                        .catch(error => {
                            this.$message.error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
                            console.error(error);
                        });
                });
            },

            // æ‰¹é‡ç§»é™¤åˆ†æ”¯
            handleBatchRemove() {
                if (this.selectedMixedBranches.length === 0) {
                    this.$message.warning('è¯·é€‰æ‹©è¦é€€å‡ºçš„åˆ†æ”¯');
                    return;
                }

                this.$confirm(`ç¡®è®¤å°†é€‰ä¸­çš„${this.selectedMixedBranches.length}ä¸ªåˆ†æ”¯ä»ä¸­é—´åˆ†æ”¯ä¸­é€€å‡ºå—ï¼Ÿ`, 'æç¤º', {
                    confirmButtonText: 'ç¡®å®š',
                    cancelButtonText: 'å–æ¶ˆ',
                    type: 'warning'
                }).then(() => {
                    const operator = localStorage.getItem('operator');
                    if (!operator) {
                        this.$message.error('è¯·å…ˆç™»å½•è®¾ç½®æ“ä½œäºº');
                        return;
                    }

                    this.batchRemoveLoading = true;

                    const params = {
                        mixBranchId: this.mixBranchId,
                        gitBranchNameList: this.selectedMixedBranches.map(b => b.branchName),
                        operator: operator
                    };

                    axios.post('/api/v1/git-merge-flow/removeFromMixBranch', params)
                        .then(response => {
                            if (response?.data?.code === 200) {
                                // æ›´æ–°mixBranchId
                                if (response.data.data && response.data.data.mixBranchId) {
                                    this.mixBranchId = response.data.data.mixBranchId;
                                    this.updateUrlMixBranchId(this.mixBranchId);
                                }
                                this.$message.success('æ‰¹é‡é€€å‡ºæˆåŠŸ');
                                this.loadData();
                            } else {
                                this.$message.error(response.data.message || 'æ‰¹é‡é€€å‡ºå¤±è´¥');
                            }
                        })
                        .catch(error => {
                            this.$message.error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
                            console.error(error);
                        })
                        .finally(() => {
                            this.batchRemoveLoading = false;
                        });
                });
            },

            // åŠ å…¥å•ä¸ªåˆ†æ”¯
            handleAddBranch(row) {
                const operator = localStorage.getItem('operator');
                if (!operator) {
                    this.$message.error('è¯·å…ˆç™»å½•è®¾ç½®æ“ä½œäºº');
                    return;
                }

                const params = {
                    mixBranchId: this.mixBranchId,
                    gitBranchNameList: [row.branchName],
                    operator: operator
                };

                axios.post('/api/v1/git-merge-flow/addIntoMixBranch', params)
                    .then(response => {
                        if (response?.data?.code === 200) {
                            this.$message.success('åŠ å…¥æˆåŠŸ');
                            this.loadData();
                        } else {
                            this.$message.error(response.data.message || 'åŠ å…¥å¤±è´¥');
                        }
                    })
                    .catch(error => {
                        this.$message.error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
                        console.error(error);
                    });
            },

            // æ‰¹é‡åŠ å…¥åˆ†æ”¯
            handleBatchAdd() {
                if (this.selectedToMixBranches.length === 0) {
                    this.$message.warning('è¯·é€‰æ‹©è¦åŠ å…¥çš„åˆ†æ”¯');
                    return;
                }

                const operator = localStorage.getItem('operator');
                if (!operator) {
                    this.$message.error('è¯·å…ˆç™»å½•è®¾ç½®æ“ä½œäºº');
                    return;
                }

                this.batchAddLoading = true;

                const params = {
                    mixBranchId: this.mixBranchId,
                    gitBranchNameList: this.selectedToMixBranches.map(b => b.branchName),
                    operator: operator
                };

                axios.post('/api/v1/git-merge-flow/addIntoMixBranch', params)
                    .then(response => {
                        if (response?.data?.code === 200) {
                            this.$message.success('æ‰¹é‡åŠ å…¥æˆåŠŸ');
                            this.loadData();
                        } else {
                            this.$message.error(response.data.message || 'æ‰¹é‡åŠ å…¥å¤±è´¥');
                        }
                    })
                    .catch(error => {
                        this.$message.error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
                        console.error(error);
                    })
                    .finally(() => {
                        this.batchAddLoading = false;
                    });
            },

            // æ¸…ç†å•ä¸ªåˆ†æ”¯
            handleCleanBranch(row) {
                this.$confirm('ç¡®è®¤åˆ é™¤è¯¥åˆ†æ”¯å—ï¼Ÿ', 'æç¤º', {
                    confirmButtonText: 'ç¡®å®š',
                    cancelButtonText: 'å–æ¶ˆ',
                    type: 'warning'
                }).then(() => {
                    const operator = localStorage.getItem('operator');
                    if (!operator) {
                        this.$message.error('è¯·å…ˆç™»å½•è®¾ç½®æ“ä½œäºº');
                        return;
                    }

                    const params = {
                        projectId: this.projectId,
                        gitBranchNameList: [row.branchName],
                        operator: operator
                    };

                    axios.post('/api/v1/git-merge-flow/deleteGitBranch', params)
                        .then(response => {
                            if (response?.data?.code === 200) {
                                this.$message.success('åˆ é™¤æˆåŠŸ');
                                this.loadData();
                            } else {
                                this.$message.error(response.data.message || 'åˆ é™¤å¤±è´¥');
                            }
                        })
                        .catch(error => {
                            this.$message.error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
                            console.error(error);
                        });
                });
            },

            // æ‰¹é‡æ¸…ç†åˆ†æ”¯
            handleBatchClean() {
                if (this.selectedToMixBranches.length === 0) {
                    this.$message.warning('è¯·é€‰æ‹©è¦æ¸…ç†çš„åˆ†æ”¯');
                    return;
                }

                this.$confirm(`ç¡®è®¤åˆ é™¤é€‰ä¸­çš„${this.selectedToMixBranches.length}ä¸ªåˆ†æ”¯å—ï¼Ÿ`, 'æç¤º', {
                    confirmButtonText: 'ç¡®å®š',
                    cancelButtonText: 'å–æ¶ˆ',
                    type: 'warning'
                }).then(() => {
                    const operator = localStorage.getItem('operator');
                    if (!operator) {
                        this.$message.error('è¯·å…ˆç™»å½•è®¾ç½®æ“ä½œäºº');
                        return;
                    }

                    this.batchCleanLoading = true;

                    const params = {
                        projectId: this.projectId,
                        gitBranchNameList: this.selectedToMixBranches.map(b => b.branchName),
                        operator: operator
                    };

                    axios.post('/api/v1/git-merge-flow/deleteGitBranch', params)
                        .then(response => {
                            if (response?.data?.code === 200) {
                                this.$message.success('æ‰¹é‡åˆ é™¤æˆåŠŸ');
                                this.loadData();
                            } else {
                                this.$message.error(response.data.message || 'æ‰¹é‡åˆ é™¤å¤±è´¥');
                            }
                        })
                        .catch(error => {
                            this.$message.error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
                            console.error(error);
                        })
                        .finally(() => {
                            this.batchCleanLoading = false;
                        });
                });
            },

            // æ–°å»ºåˆ†æ”¯
            handleCreateBranch() {
                this.loadSourceBranches();
                this.createBranchVisible = true;
            },

            // åŠ è½½æ¥æºåˆ†æ”¯
            loadSourceBranches() {
                const params = {
                    gitProjectId: this.projectId,
                    includeDefaultBranch: true // åŒ…å«é»˜è®¤åˆ†æ”¯
                };

                axios.post('/api/v1/git-merge-flow/listGitBranch', params)
                    .then(response => {
                        if (response?.data?.code === 200) {
                            this.sourceBranches = response.data.data;
                            // é»˜è®¤é€‰ä¸­é»˜è®¤åˆ†æ”¯
                            const defaultBranch = this.sourceBranches.find(b => b.defaultBranchFlag === 1);
                            if (defaultBranch) {
                                this.createBranchForm.sourceBranch = defaultBranch.branchName;
                            }
                        } else {
                            this.$message.error('è·å–æ¥æºåˆ†æ”¯å¤±è´¥');
                        }
                    })
                    .catch(error => {
                        this.$message.error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
                        console.error(error);
                    });
            },

            // ä¿å­˜åˆ†æ”¯
            handleSaveBranch() {
                this.$refs.createBranchForm.validate((valid) => {
                    if (valid) {
                        const operator = localStorage.getItem('operator');
                        if (!operator) {
                            this.$message.error('è¯·å…ˆç™»å½•è®¾ç½®æ“ä½œäºº');
                            return;
                        }

                        this.saveBranchLoading = true;

                        const params = {
                            gitProjectId: this.projectId,
                            sourceBranch: this.createBranchForm.sourceBranch,
                            gitBranchName: this.createBranchForm.branchName,
                            branchDesc: this.createBranchForm.branchDesc,
                            operator: operator
                        };

                        axios.post('/api/v1/git-merge-flow/createGitBranch', params)
                            .then(response => {
                                if (response?.data?.code === 200) {
                                    this.$message.success('åˆ›å»ºæˆåŠŸ');
                                    this.createBranchVisible = false;
                                    this.createBranchForm = {
                                        sourceBranch: '',
                                        branchName: '',
                                        branchDesc: ''
                                    };
                                    this.loadData();
                                } else {
                                    this.$message.error(response.data.message || 'åˆ›å»ºå¤±è´¥');
                                }
                            })
                            .catch(error => {
                                this.$message.error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
                                console.error(error);
                            })
                            .finally(() => {
                                this.saveBranchLoading = false;
                            });
                    }
                });
            },

            // åˆå§‹åŒ–æ“ä½œäºº
            initOperator() {
                const operator = localStorage.getItem('operator');
                if (operator) {
                    this.operatorButtonText = operator;
                } else {
                    this.operatorButtonText = 'ç™»å½•';
                }
            },

            // æ“ä½œäººç™»å½•
            handleOperatorLogin() {
                const operator = localStorage.getItem('operator');
                this.operatorForm.operator = operator || '';
                this.operatorLoginVisible = true;
            },

            // å›è½¦é”®ä¿å­˜æ“ä½œäºº
            handleEnterKeySave(event) {
                // å½»åº•é˜»æ­¢æ‰€æœ‰é»˜è®¤è¡Œä¸º
                if (event) {
                    event.preventDefault();
                    event.stopPropagation();
                    event.stopImmediatePropagation();
                    
                    // é˜»æ­¢è¡¨å•æäº¤
                    if (event.target && event.target.form) {
                        event.target.form.onsubmit = function() { return false; };
                    }
                }
                
                // å»¶è¿Ÿæ‰§è¡Œä¿å­˜ï¼Œç¡®ä¿äº‹ä»¶å®Œå…¨å¤„ç†å®Œæ¯•
                this.$nextTick(() => {
                    this.handleSaveOperator();
                });
            },

            // å…³é—­æ“ä½œäººå¯¹è¯æ¡†
            handleCloseOperatorDialog() {
                this.operatorLoginVisible = false;
            },

            // ä¿å­˜æ“ä½œäºº
            handleSaveOperator() {
                // æ‰‹åŠ¨éªŒè¯æ“ä½œäººè¾“å…¥
                if (!this.operatorForm.operator || this.operatorForm.operator.trim() === '') {
                    this.$message.error('è¯·è¾“å…¥æ“ä½œäºº');
                    return;
                }
                
                // ä¿å­˜åˆ°localStorage
                localStorage.setItem('operator', this.operatorForm.operator.trim());
                this.operatorButtonText = this.operatorForm.operator.trim();
                this.operatorLoginVisible = false;
                this.$message.success('æ“ä½œäººè®¾ç½®æˆåŠŸ');
            },

            // æ›´æ–°URLä¸­çš„mixBranchIdå‚æ•°
            updateUrlMixBranchId(newMixBranchId) {
                try {
                    const url = new URL(window.location);
                    url.searchParams.set('mixBranchId', newMixBranchId);
                    window.history.replaceState({}, '', url);
                } catch (error) {
                    console.error('æ›´æ–°URLå¤±è´¥:', error);
                }
            }
        }
    });
</script>
</body>
</html>